<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATTY MAFIA | Ultra Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --neon-blue: #00f3ff; --neon-purple: #bc13fe; --bg-dark: #000000; --mafia-red: #ff003c; --dead-gray: #444444; }
        body, html { margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; background: var(--bg-dark); color: #fff; height: 100dvh; overflow: hidden; touch-action: manipulation; }
        .grid-bg { position: fixed; top: 0; left: 0; z-index: -1; width: 200%; height: 200%; background-image: linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(188, 19, 254, 0.1) 1px, transparent 1px); background-size: 50px 50px; transform: perspective(1000px) rotateX(60deg); transform-origin: center top; animation: moveGrid 15s linear infinite; }
        @keyframes moveGrid { from { background-position: 0 0; } to { background-position: 0 50px; } }
        .cyber-card { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); width: 100%; max-width: 500px; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; margin: 0 auto; }
        .screen { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #notify-box { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 5px; width: 90%; max-width: 400px; }
        .toast { background: rgba(0, 0, 0, 0.9); border-left: 3px solid var(--neon-blue); color: #fff; padding: 10px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-20px); } to { transform: translateY(0); } }
        #role-hud { background: #000; border-bottom: 2px solid var(--neon-blue); padding: 8px; text-align: center; display: none; font-family: 'Orbitron'; font-size: 11px; }
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 13px; line-height: 1.4; }
        .msg-player { background: rgba(0, 243, 255, 0.1); border-left: 2px solid var(--neon-blue); align-self: flex-start; }
        .msg-mafia { background: rgba(255, 0, 60, 0.15); border-right: 2px solid var(--mafia-red); align-self: flex-end; color: #ffb3b3; }
        .msg-dead { background: rgba(68, 68, 68, 0.2); color: var(--dead-gray); align-self: center; font-style: italic; }
        .msg-system { background: rgba(255, 255, 255, 0.05); color: var(--neon-blue); text-align: center; font-size: 11px; align-self: center; border-radius: 5px; width: 90%; padding: 5px; }
        .translate-btn { font-size: 10px; color: var(--neon-blue); cursor: pointer; text-decoration: underline; margin-top: 3px; display: block; }
        .neon-btn { background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); color: #000; font-weight: bold; border-radius: 10px; transition: 0.2s; }
        .role-card-reveal { background: linear-gradient(135deg, #000, #111); border: 3px solid var(--neon-blue); padding: 2rem; border-radius: 2rem; box-shadow: 0 0 50px var(--neon-blue); animation: cardIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes cardIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .action-area { padding: 15px; background: rgba(0,0,0,0.8); border-top: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div class="grid-bg"></div>
<div id="notify-box"></div>
<div id="role-hud">ACCESS: <span id="hud-role-name" class="font-black ml-2 text-white">SYNCING...</span></div>

<div class="cyber-card">
    <header class="p-4 border-b border-white/10 flex justify-between items-center bg-black/40">
        <div>
            <h1 style="font-family: 'Orbitron', sans-serif;" class="text-lg font-black tracking-tighter">MATTY <span style="color:var(--neon-blue)">MAFIA</span></h1>
            <p id="room-status" class="text-[8px] text-gray-500 uppercase tracking-widest">Sector: Searching...</p>
        </div>
        <div id="status-glow" class="w-3 h-3 rounded-full bg-red-600"></div>
    </header>

    <div class="flex-1 relative flex flex-col overflow-hidden">
        <section id="screen-auth" class="screen active justify-center p-6 items-center text-center">
            <div class="mb-6"><i data-lucide="shield-check" class="w-12 h-12 text-cyan-400 mx-auto"></i></div>
            <h2 class="text-2xl font-bold orbitron mb-6 uppercase">Infiltration</h2>
            <div class="w-full space-y-3">
                <input type="text" id="user-name" placeholder="Agent Alias" class="bg-white/5 border border-white/10 p-3 rounded-lg w-full outline-none focus:border-cyan-500 text-center text-white">
                <input type="text" id="room-id" placeholder="Sector Key" class="bg-white/5 border border-white/10 p-3 rounded-lg w-full outline-none focus:border-cyan-500 text-center font-mono text-white">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="handleJoin()" class="p-3 rounded-lg border border-white/10 font-bold text-sm">JOIN</button>
                    <button onclick="handleCreate()" class="p-3 neon-btn text-sm uppercase">CREATE</button>
                </div>
            </div>
        </section>

        <section id="screen-lobby" class="screen p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold orbitron">Sector: <span id="display-room-id" class="text-cyan-400">----</span></h2>
                <span id="player-count" class="text-[10px] text-gray-400">0 AGENTS</span>
            </div>
            <div id="lobby-list" class="flex-1 space-y-2 overflow-y-auto"></div>
            <button id="start-btn" onclick="startGame()" class="w-full neon-btn p-4 mt-4 hidden uppercase text-sm">Initiate Mission</button>
        </section>

        <section id="screen-role" class="screen items-center justify-center p-6 text-center">
            <div class="role-card-reveal">
                <div class="w-20 h-20 border-2 border-white/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <i id="role-main-icon" data-lucide="skull" class="w-10 h-10"></i>
                </div>
                <h3 class="text-gray-500 text-[10px] uppercase mb-2">You are assigned as</h3>
                <h2 id="role-title" class="text-5xl font-black mb-6 orbitron tracking-tighter">...</h2>
                <p id="role-desc" class="text-xs text-gray-400 leading-relaxed">Prepare for the mission.</p>
            </div>
        </section>

        <section id="screen-game" class="screen">
            <div class="p-2 bg-white/5 border-b border-white/10 flex justify-between items-center px-4">
                <div class="text-[10px] font-black text-cyan-400 uppercase tracking-widest" id="phase-title">SYNCING</div>
                <div id="turn-indicator" class="text-[9px] bg-white/10 px-2 py-0.5 rounded italic uppercase">Waiting</div>
            </div>
            <div id="chat-box" class="chat-container"></div>
            <div class="action-area">
                <div id="action-grid" class="grid grid-cols-2 gap-2 mb-3 overflow-x-auto"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Secure link..." class="flex-1 bg-white/5 border border-white/20 p-2 rounded-lg text-xs outline-none focus:border-cyan-500 text-white">
                    <button onclick="sendMessage()" class="bg-cyan-500 w-10 h-10 rounded-lg flex items-center justify-center"><i data-lucide="send" class="w-4 h-4 text-black"></i></button>
                </div>
            </div>
        </section>

        <section id="screen-result" class="screen items-center justify-center text-center p-6">
            <h2 id="winner-name" class="text-3xl font-black mb-4 orbitron">MISSION END</h2>
            <p id="winner-detail" class="text-gray-400 text-sm mb-8"></p>
            <button onclick="location.reload()" class="w-full neon-btn p-4 uppercase text-sm">Re-Initialize</button>
        </section>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCgc3oYJOrdOV9Y22x7MzBUEJSGGXsfXUU",
        authDomain: "mafia-game-7dc88.firebaseapp.com",
        databaseURL: "https://mafia-game-7dc88-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "mafia-game-7dc88",
        storageBucket: "mafia-game-7dc88.firebasestorage.app",
        messagingSenderId: "776724825938",
        appId: "1:776724825938:web:afab585356cb94f9a15c8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let local = { id: '', name: '', role: '', isAlive: true, isHost: false, room: '', phase: '', actionTaken: false };
    const roleMeta = {
        'Mafia': { icon: 'skull', color: '#ff003c', desc: 'Eliminate citizens. Stay in the shadows.' },
        'Doctor': { icon: 'heart-pulse', color: '#00ff88', desc: 'Protect an agent from death every night.' },
        'Detective': { icon: 'search', color: '#00f3ff', desc: 'Scan an agent to reveal their role.' },
        'Citizen': { icon: 'user', color: '#ffffff', desc: 'Find and vote out the hidden Mafia.' }
    };

    function notify(msg) {
        const box = document.getElementById('notify-box');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        box.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function navigate(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        lucide.createIcons();
    }

    function handleCreate() {
        const name = document.getElementById('user-name').value.trim();
        if(!name) return;
        local.room = Math.floor(1000 + Math.random() * 9000).toString();
        local.id = 'p_' + Date.now(); local.name = name; local.isHost = true;
        db.ref('games/' + local.room).set({
            status: 'lobby', host: local.id,
            players: { [local.id]: { name: name, isAlive: true, role: '' } }
        }).then(() => { listen(); notify("Sector Initialized."); });
    }

    function handleJoin() {
        const name = document.getElementById('user-name').value.trim();
        const rId = document.getElementById('room-id').value.trim();
        if(!name || !rId) return;
        local.room = rId; local.name = name;
        db.ref(`games/${rId}`).once('value', snap => {
            if(!snap.exists()) return notify("Sector Not Found.");
            const data = snap.val();
            let existingId = Object.keys(data.players).find(k => data.players[k].name === name);
            local.id = existingId || 'p_' + Date.now();
            if(!existingId) db.ref(`games/${rId}/players/${local.id}`).set({ name: name, isAlive: true, role: '' });
            listen();
        });
    }

    function listen() {
        document.getElementById('room-status').innerText = "Sector: " + local.room;
        document.getElementById('display-room-id').innerText = local.room;
        db.ref('games/' + local.room).on('value', snap => {
            const data = snap.val(); if(!data) return;

            if(data.status === 'lobby') {
                const players = Object.values(data.players);
                document.getElementById('lobby-list').innerHTML = players.map(p => `<div class="p-3 bg-white/5 border border-white/10 rounded-lg flex justify-between items-center text-sm font-bold"><span>${p.name}</span><span class="text-cyan-400 text-[9px]">ONLINE</span></div>`).join('');
                document.getElementById('player-count').innerText = players.length + " AGENTS";
                if(local.isHost && players.length >= 4) document.getElementById('start-btn').classList.remove('hidden');
                navigate('screen-lobby');
            }

            if(data.status === 'assigning') {
                const me = data.players[local.id];
                if(me && me.role) {
                    local.role = me.role;
                    document.getElementById('role-title').innerText = local.role;
                    document.getElementById('role-title').style.color = roleMeta[local.role].color;
                    document.getElementById('role-main-icon').setAttribute('data-lucide', roleMeta[local.role].icon);
                    navigate('screen-role');
                    setTimeout(() => navigate('screen-game'), 5000);
                }
            }

            if(data.status === 'night' || data.status === 'day') {
                const me = data.players[local.id];
                if(me) { 
                    local.role = me.role; local.isAlive = me.isAlive;
                    updateHUD(); 
                    if(local.phase !== data.status) { local.phase = data.status; local.actionTaken = false; }
                }
                renderGame(data);
                if(local.isHost) checkLoop(data);
                checkWin(data);
            }

            if(data.status === 'result') showResult(data.winner);
            if(data.messages) renderMsgs(data.messages);
        });
    }

    function updateHUD() {
        document.getElementById('role-hud').style.display = 'block';
        const hud = document.getElementById('hud-role-name');
        hud.innerText = local.role + (local.isAlive ? "" : " [TERMINATED]");
        hud.style.color = local.isAlive ? roleMeta[local.role].color : "#444";
    }

    function renderGame(data) {
        navigate('screen-game');
        const grid = document.getElementById('action-grid');
        const indicator = document.getElementById('turn-indicator');
        const phaseTitle = document.getElementById('phase-title');
        grid.innerHTML = '';
        phaseTitle.innerText = data.status + " PHASE";

        if(data.status === 'night') {
            if(local.actionTaken) { indicator.innerText = "ACTION LOGGED"; return; }
            indicator.innerText = "YOUR ACTION";
            if(local.role === 'Mafia' && local.isAlive) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive && data.players[id].role !== 'Mafia') 
                        grid.innerHTML += `<button onclick="doAction('nightVotes', '${id}')" class="p-2 border border-red-500/40 bg-red-900/10 rounded text-[9px] uppercase">Eliminate ${data.players[id].name}</button>`;
                });
            } else if(local.role === 'Doctor' && local.isAlive && !data.nightActions?.heal) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive) 
                        grid.innerHTML += `<button onclick="doAction('nightActions/heal', '${id}')" class="p-2 border border-green-500/40 bg-green-900/10 rounded text-[9px] uppercase">Protect ${data.players[id].name}</button>`;
                });
            } else { indicator.innerText = "WAITING"; }
        } else {
            indicator.innerText = "VOTING OPEN";
            if(local.isAlive && !local.actionTaken) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive) 
                        grid.innerHTML += `<button onclick="doAction('dayVotes', '${id}')" class="p-2 border border-white/20 bg-white/5 rounded text-[9px] uppercase">Vote ${data.players[id].name}</button>`;
                });
            } else if(local.actionTaken) { indicator.innerText = "VOTE CASTED"; }
        }
    }

    function doAction(path, tid) {
        local.actionTaken = true;
        db.ref(`games/${local.room}/${path}/${local.id}`).set(tid);
        notify("Action Recorded.");
    }

    function startGame() {
        db.ref(`games/${local.room}/players`).once('value', s => {
            const players = s.val(); const ids = Object.keys(players);
            let roles = ['Mafia', 'Doctor', 'Detective'];
            while(roles.length < ids.length) roles.push('Citizen');
            roles.sort(() => Math.random() - 0.5);
            const up = { status: 'assigning' };
            ids.forEach((id, i) => up[`players/${id}/role`] = roles[i]);
            db.ref(`games/${local.room}`).update(up).then(() => {
                setTimeout(() => db.ref(`games/${local.room}`).update({ status: 'night', nightActions: { init: true }, nightVotes: { init: true } }), 6000);
            });
        });
    }

    // --- GAME LOGIC ENGINE (HOST ONLY) ---
    function checkLoop(data) {
        const players = Object.values(data.players);
        const alive = players.filter(p => p.isAlive);
        
        if(data.status === 'night') {
            const mafiaCount = alive.filter(p => p.role === 'Mafia').length;
            const votesCount = data.nightVotes ? Object.keys(data.nightVotes).length - 1 : 0;
            const hasDoc = alive.some(p => p.role === 'Doctor');
            const docDone = !hasDoc || (data.nightActions && data.nightActions.heal);

            if(votesCount >= mafiaCount && docDone) {
                // Calculate victim
                const vArr = Object.values(data.nightVotes).filter(v => v !== true);
                const freq = {}; vArr.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const victimId = Object.keys(freq).reduce((a,b) => freq[a] > freq[b] ? a : b);
                
                let resultMsg = "A quiet night.";
                if(victimId !== data.nightActions?.heal) {
                    db.ref(`games/${local.room}/players/${victimId}`).update({ isAlive: false });
                    resultMsg = `Morning news: ${data.players[victimId].name} was found dead!`;
                } else { resultMsg = "The Doctor saved the target tonight!"; }

                db.ref(`games/${local.room}`).update({ status: 'day', dayVotes: { init: true }, nightVotes: { init: true }, nightActions: { init: true } });
                sendSystemMsg(resultMsg);
            }
        } else if (data.status === 'day') {
            const votesCount = data.dayVotes ? Object.keys(data.dayVotes).length - 1 : 0;
            if(votesCount >= alive.length) {
                const vArr = Object.values(data.dayVotes).filter(v => v !== true);
                const freq = {}; vArr.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const votedId = Object.keys(freq).reduce((a,b) => freq[a] > freq[b] ? a : b);
                
                db.ref(`games/${local.room}/players/${votedId}`).update({ isAlive: false });
                const msg = `${data.players[votedId].name} was executed by the sector.`;
                db.ref(`games/${local.room}`).update({ status: 'night', nightVotes: { init: true }, nightActions: { init: true } });
                sendSystemMsg(msg);
            }
        }
    }

    function checkWin(data) {
        const players = Object.values(data.players);
        const mafia = players.filter(p => p.isAlive && p.role === 'Mafia').length;
        const citizens = players.filter(p => p.isAlive && p.role !== 'Mafia').length;
        if(mafia === 0) db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Citizens' });
        else if(mafia >= citizens) db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Mafia' });
    }

    function showResult(winner) {
        document.getElementById('winner-name').innerText = winner.toUpperCase() + " WINS";
        document.getElementById('winner-detail').innerText = winner === 'Mafia' ? "The citizens failed." : "The threat is eliminated.";
        navigate('screen-result');
    }

    function sendMessage() {
        const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
        const isMafiaChat = (local.role === 'Mafia' && local.phase === 'night');
        db.ref(`games/${local.room}/messages`).push({ sender: local.name, text: txt, type: isMafiaChat?'mafia':'player', isAlive: local.isAlive });
        inp.value = '';
    }

    function sendSystemMsg(txt) { db.ref(`games/${local.room}/messages`).push({ sender: 'SYSTEM', text: txt, type: 'system', isAlive: true }); }

    function renderMsgs(msgs) {
        const box = document.getElementById('chat-box'); box.innerHTML = '';
        Object.values(msgs).forEach(m => {
            if(m.type === 'mafia' && local.role !== 'Mafia') return;
            if(!m.isAlive && local.isAlive && m.type !== 'system') return;
            const div = document.createElement('div');
            let c = m.type==='mafia'?'msg-mafia':(!m.isAlive?'msg-dead':(m.type==='system'?'msg-system':'msg-player'));
            div.className = `msg ${c}`;
            div.innerHTML = `${m.type!=='system'?`<strong>${m.sender}</strong>`:''} <span>${m.text}</span> <a class="translate-btn" onclick="translateUI('${m.text}', this)">Translate</a>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function translateUI(txt, el) {
        const l = prompt("Lang code: ar, en, es, fr", "ar");
        if(!l) return;
        fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|${l}`)
            .then(r => r.json()).then(j => { if(j.responseData) el.previousElementSibling.innerText = j.responseData.translatedText; });
    }

    db.ref(".info/connected").on("value", s => {
        document.getElementById('status-glow').style.backgroundColor = s.val() ? "#00f3ff" : "#ff003c";
    });
    lucide.createIcons();
</script>
</body>
</html>
